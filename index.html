<!DOCTYPE html>
<meta charset="utf-8">
<style>

path {
	stroke:#163A24;	
	fill:white;
}



</style>
<body>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="http://underscorejs.org/underscore.js"></script>
	<script>

	var width = 960,
	height = 960;		

	var continentColors = {
		Africa:["#C15A2E","#DA6C31","#EB8C2F","#EBBA26"],
		Antarctica:["#3C2820"],
		Asia:["#4B1E3C","#531A3F","#692550","#5E2550"],
		Europe:["#CC3B2B","#79292D","#9A2B29","#E7342B","#B13929"],
		"North America":["#4D6D95","#60799C","#4A6486","#38557A"],
		Oceania:["#3C2820","#56342A"],
		"South America":["#888F2D","#727B37","#5B642C","#798F2D"],
		"Seven Seas (open ocean)":["#3C2820"]
	};

	var stories = {
		"Sparking Change":["Burkina Faso","Kenya","Uganda"],
		"Safe World For Girls":["Malawi","India"],
		"Reinventing Equality":["Croatia","Georgia"],
		"Fully Charged (FLOW)":["Bangladesh","China","Fiji","Indonesia","Kyrgyzstan","Marshall Islands","Philippines","Samoa","Sri Lanka","Tajikistan","Timor-Leste","Tonga","Vietnam","Nepal","Cambodia","India","Pakistan"],
		"Wired to Defend":["Guatemala","Bolivia","Ecuador","Mexico","Honduras","El Salvador","Nicaragua"],
		"Electrifying Action":["Lebanon","Jordan"],
		"Shutting Down Trafficking":["India","Indonesia","Nepal","Philippines","Thailand"] 
	}; 

	var svg = d3.select("body").append("svg").attr("width", width).attr("height", height); 

	var projection = d3.geo.orthographic().scale(450).translate([width / 2, height / 2]).clipAngle(90).precision(0.1);

	var path = d3.geo.path().projection(projection);
			var circle = d3.geo.circle(); 


	svg.append("path")
	.datum({type: "Sphere"})
	.attr("class", "sphere")
	.attr("d", path); 

	d3.json("ocean.json",function(error,ocean){
		var ocean = topojson.feature(ocean, ocean.objects.ocean).features; 

		svg.selectAll("ocean")
		.data(ocean)
		.enter().append("path").attr("class","globe ocean")
		.attr("d", path).style("fill", "#343534");


	});

	d3.json("world.json", function(error, world) {
		if (error) return console.error(error);

		var colors = [2,3,4,2,2,0,0,0,0,1,2,2,2,2,1,1,3,0,3,3,2,1,0,1,0,3,3,1,2,0,1,0,2,0,1,1,1,0,1,0,3,0,3,1,1,1,0,1,1,0,1,2,2,0,0,1,0,1,1,2,1,1,2,1,1,0,0,1,1,0,0,2,1,2,0,1,0,0,0,0,0,2,0,2,0,0,3,0,3,2,2,2,2,2,0,0,1,3,2,2,2,0,1,0,2,0,2,2,0,3,3,0,0,0,0,1,0,1,1,0,0,0,0,0,2,0,0,2,0,2,1,3,1,0,0,0,3,0,1,0,1,0,0,0,2,0,1,1,2,0,3,0,1,1,1,0,1,3,0,0,0,0,2,0,1,2,1,1,0,1,2,0,0,2,2,2,1]; 

		console.log(colors.length);

		var countries = topojson.feature(world, world.objects.countries).features; 

		console.log(world.objects);

		/*neighbors1 = _.chain(world.objects.countries.geometries).groupBy(function(country){
			return country.properties.continent;
		}).each(function(continent,key,list){
			list[key] = topojson.neighbors(continent);
		}).value();*/

	var neighbors = topojson.neighbors(world.objects.countries.geometries);

	var group = svg.append("g").attr("class", "all-path");

	group.selectAll("country")
	.data(countries)
	.enter().append("path")
	.attr("class", function(d) { return "globe country " + d.properties["name_long"].replace(" ","")+" continent "+d.properties.continent.replace(" ",""); })
	.attr("d", path).style("fill", function(d, i) { 
		var continent = continentColors[d.properties.continent];
		return continent && continent.length?continent[colors[i]%continent.length]:"black";
	});

	/*
	add points
	*/

	_.each(stories,function(countries,story){
		_.each(countries,function(country){
			var countryPath = d3.select("."+country.replace(" ",""));
			if(countryPath.empty()){
				console.log(country);
			}else{
				var centroid = d3.geo.centroid(countryPath.data()[0]);
				svg.append("path").attr("class","point").attr("d", path(circle.origin(centroid).angle(1)())).attr("country",country.replace(" ",""));
			}
		});	
	});

}); 

	/*
	Interaction behavior
	*/

	var manualRotationActivated;
	var animationRequest; 
	var m0;
	var o0; 

	var currentRotation = [0, 0, 0]; 
	var manualRotationActivated = false;        

	var mouseDown = function() {
		m0 = [d3.event.pageX, d3.event.pageY];
		o0 = projection.rotate();
		manualRotationActivated = true;
		animationRequest = requestAnimationFrame(rotate);
		d3.event.preventDefault();
	};

	var mouseUp = function() {
		manualRotationActivated = false;
		if (m0) {
			m0 = null;
		}
	};

	var mouseMove = function() {
		var m1, o1;
		if (m0) {
			m1 = [d3.event.pageX, d3.event.pageY];
			o1 = [o0[0] + (m1[0] - m0[0]) / 6, o0[1] + (m0[1] - m1[1]) / 6];
			o1[1] = (o1[1] > 30 ? 30 : (o1[1] < -30 ? -30 : o1[1]));
			currentRotation[0] = o1[0];
		}
	};

	var rotate = function() {
		if (manualRotationActivated) {
			redrawPathsOnRotationOrScale(currentRotation, projection.scale());
			animationRequest = requestAnimationFrame(rotate);
		}
	};

	var redrawPathsOnRotationOrScale = function(rotation, scale) {
		currentRotation = rotation;
		projection.rotate(currentRotation).scale(scale);
		d3.selectAll(".globe").attr("d", path);
		d3.selectAll(".point").attr("d", function(d){
			var point = d3.select(this);
			var countryPath = d3.select("."+point.attr("country"));
			var centroid = d3.geo.centroid(countryPath.data()[0]);
			return path(circle.origin(centroid).angle(1)());
		});
	};

	d3.select("body")
	.on("mousedown", mouseDown)
	.on("mousemove", mouseMove)
	.on("mouseup", mouseUp)
	.on("touchstart", mouseDown)
	.on("touchmove", mouseMove)
	.on("touchend", mouseUp);

	d3.select(self.frameElement).style("height", height + "px");

	</script>
